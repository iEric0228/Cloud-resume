name: 'â˜ï¸ Cloud Resume CI/CD'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - deploy-test-keep
          - deploy-test-destroy
          - destroy-only
        default: deploy-test-destroy
      
      keep_alive_minutes:
        description: 'Minutes to keep running (for demos)'
        type: string
        default: '1'

  pull_request:
    branches: [ main ]
    paths:
      - 'website/**'
      - 'infra/**'

  push:
    branches: [ main ]
    paths:
      - 'website/**'
      - 'infra/**'

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

jobs:
  # Validation job (runs on PRs)
  validate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: âš¡ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ðŸ” Validate Everything
      run: |
        # Terraform validation
        cd infra/environments/dev
        terraform init
        terraform validate
        terraform fmt -check
        echo "âœ… Terraform validation passed"
        
        # Website validation
        cd ../../../
        required_files=("website/index.html" "website/css/styles.css" "website/js/visitor-counter.js")
        for file in "${required_files[@]}"; do
          [[ -f "$file" ]] && echo "âœ… $file" || { echo "âŒ Missing $file"; exit 1; }
        done
        echo "âœ… Website files validation passed"

  # Main deploy job (runs on push, manual dispatch)
  deploy-resume:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: âš¡ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: ðŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::125156866057:role/github-OICD
        role-session-name: cloud-resume-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ðŸ—ï¸ Deploy Infrastructure
      if: github.event.inputs.action != 'destroy-only'
      working-directory: ./infra/environments/dev
      run: |
        echo "ðŸš€ Deploying cloud resume infrastructure..."
        terraform init
        terraform apply -auto-approve
        
        echo "ðŸ” Debug: Available Terraform outputs:"
        terraform output || echo "âŒ No outputs available"
        
        # Export outputs with better error handling
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        WEBSITE_URL=$(terraform output -raw website_url 2>/dev/null || echo "")  
        API_URL=$(terraform output -raw api_url 2>/dev/null || echo "")
        
        echo "ðŸ” Debug: Extracted values:"
        echo "S3_BUCKET='$S3_BUCKET'"
        echo "WEBSITE_URL='$WEBSITE_URL'"
        echo "API_URL='$API_URL'"
        
        # Validate required outputs
        if [ -z "$S3_BUCKET" ]; then
          echo "âŒ ERROR: S3 bucket name is empty!"
          echo "ðŸ” All available outputs:"
          terraform output -json || echo "No JSON outputs available"
          exit 1
        fi
        
        if [ -z "$WEBSITE_URL" ]; then
          echo "âŒ ERROR: Website URL is empty!"
          exit 1
        fi
        
        if [ -z "$API_URL" ]; then
          echo "âŒ ERROR: API URL is empty!"
          exit 1
        fi
        
        # Export to environment
        echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
        echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_ENV
        echo "API_URL=$API_URL" >> $GITHUB_ENV
        
        echo "âœ… All required outputs extracted successfully"

    - name: ðŸ“¤ Deploy Website
      if: github.event.inputs.action != 'destroy-only'
      run: |
        echo "ðŸ“¤ Deploying website files..."
        
        # Get outputs from Terraform with proper error handling
        cd infra/environments/dev
        
        # Extract outputs with proper quoting
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        API_URL=$(terraform output -raw api_url 2>/dev/null || echo "")
        WEBSITE_URL=$(terraform output -raw website_url 2>/dev/null || echo "")
        
        # Validate outputs exist
        if [[ -z "$S3_BUCKET" || -z "$API_URL" || -z "$WEBSITE_URL" ]]; then
          echo "âŒ ERROR: Missing required Terraform outputs"
          echo "S3_BUCKET: '$S3_BUCKET'"
          echo "API_URL: '$API_URL'"
          echo "WEBSITE_URL: '$WEBSITE_URL'"
          exit 1
        fi
        
        echo "ðŸ” Using S3 bucket: $S3_BUCKET"
        echo "ðŸ” Using API URL: $API_URL"
        echo "ðŸ” Using Website URL: $WEBSITE_URL"
        
        # Go back to project root
        cd ../../../
        
        # Verify website directory exists
        if [[ ! -d "website" ]]; then
          echo "âŒ ERROR: website directory not found"
          ls -la
          exit 1
        fi
        
        echo "âœ… Found website directory"
        ls -la website/
        
        # Update visitor counter with API URL
        echo "ðŸ”„ Updating visitor counter with API URL..."
        if [[ -f "website/js/visitor-counter.js" ]]; then
          # Create backup
          cp website/js/visitor-counter.js website/js/visitor-counter.js.bak
          
          # Replace API URL (using different delimiter to avoid issues with URL slashes)
          sed -i "s|REPLACE_WITH_API_URL|${API_URL}|g" website/js/visitor-counter.js
          
          # Verify replacement worked
          if grep -q "REPLACE_WITH_API_URL" website/js/visitor-counter.js; then
            echo "âš ï¸ WARNING: API URL replacement may have failed"
            echo "Searching for REPLACE_WITH_API_URL:"
            grep -n "REPLACE_WITH_API_URL" website/js/visitor-counter.js || true
          else
            echo "âœ… API URL replacement successful"
            echo "New API URL in file:"
            grep -n "apiUrl.*=" website/js/visitor-counter.js | head -1 || true
          fi
        else
          echo "âŒ ERROR: visitor-counter.js not found"
          exit 1
        fi
        
        # Verify all required files exist
        required_files=(
          "website/index.html"
          "website/css/styles.css" 
          "website/js/visitor-counter.js"
        )
        
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ ERROR: Required file $file not found!"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
        # Upload website files to S3
        echo "ðŸš€ Uploading website files to S3..."
        
        # Sync all files first
        aws s3 sync website/ "s3://${S3_BUCKET}/" --delete
        
        # Set specific content types and cache headers
        echo "ðŸ”§ Setting content types and cache headers..."
        
        aws s3 cp website/index.html "s3://${S3_BUCKET}/index.html" \
          --content-type "text/html" \
          --cache-control "no-cache, no-store, must-revalidate"
          
        aws s3 cp website/css/styles.css "s3://${S3_BUCKET}/css/styles.css" \
          --content-type "text/css" \
          --cache-control "max-age=31536000"
          
        aws s3 cp website/js/visitor-counter.js "s3://${S3_BUCKET}/js/visitor-counter.js" \
          --content-type "application/javascript" \
          --cache-control "max-age=3600"
        
        # Upload animation.js if it exists
        if [[ -f "website/js/animation.js" ]]; then
          aws s3 cp website/js/animation.js "s3://${S3_BUCKET}/js/animation.js" \
            --content-type "application/javascript" \
            --cache-control "max-age=31536000"
          echo "âœ… Uploaded animation.js"
        fi
        
        # Restore original visitor-counter.js
        if [[ -f "website/js/visitor-counter.js.bak" ]]; then
          mv website/js/visitor-counter.js.bak website/js/visitor-counter.js
          echo "âœ… Restored original visitor-counter.js"
        fi
        
        echo "âœ… Website deployment completed successfully!"
        echo "ðŸŒ Website available at: $WEBSITE_URL"
        
        # Test the deployment
        echo "ðŸ§ª Testing API endpoint..."
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL" || echo "000")
        if [[ "$HTTP_STATUS" == "200" ]]; then
          echo "âœ… API endpoint is responding correctly"
        else
          echo "âš ï¸ API endpoint returned status: $HTTP_STATUS"
        fi
        
        echo "ðŸŽ‰ Deployment completed! Visit your resume at: $WEBSITE_URL"

    - name: ðŸ§ª Test Deployment
      if: github.event.inputs.action != 'destroy-only'
      run: |
        echo "ðŸ§ª Testing deployed resume..."
        sleep 60  # Wait for CloudFront
        
        # Test website
        curl -f $WEBSITE_URL && echo "âœ… Website working" || echo "âŒ Website failed"
        
        # Test API
        response=$(curl -s $API_URL/count)
        echo "API Response: $response"
        if echo "$response" | grep -q "visitor_count"; then
          echo "âœ… Visitor counter API working"
        else
          echo "âŒ API test failed"
        fi

    - name: ðŸ“Š Summary
      if: github.event.inputs.action != 'destroy-only'
      run: |
        echo "## â˜ï¸ Cloud Resume Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸŒ Live Website:** [$WEBSITE_URL]($WEBSITE_URL)" >> $GITHUB_STEP_SUMMARY
        echo "**âš¡ Visitor Counter API:** $API_URL/count" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        keep_hours="${{ github.event.inputs.keep_alive_hours || '24' }}"
        if [ "${{ github.event.inputs.action }}" = "deploy-test-destroy" ]; then
          echo "â° **Auto-cleanup scheduled in $keep_hours hour(s)**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Status:** Deployed and running" >> $GITHUB_STEP_SUMMARY
        fi

    - name: â³ Keep Running (Demo Period)
      if: github.event.inputs.action == 'deploy-test-keep' || github.event.inputs.action == 'deploy-test-destroy'
      run: |
        hours="${{ github.event.inputs.keep_alive_hours || '1' }}"
        echo "â³ Keeping resume live for $hours hour(s) for demo/testing..."
        echo "ðŸŒ Visit: $WEBSITE_URL"
        sleep $(($hours * 3600))

    - name: ðŸ—‘ï¸ Cleanup
      if: always() && (github.event.inputs.action == 'deploy-test-destroy' || github.event.inputs.action == 'destroy-only')
      working-directory: ./infra/environments/dev
      run: |
        echo "ðŸ—‘ï¸ Cleaning up resources..."
        
        # Get bucket name if we need to
        if [ "${{ github.event.inputs.action }}" = "destroy-only" ]; then
          S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        fi
        
        # Empty S3 bucket
        if [ ! -z "$S3_BUCKET" ]; then
          echo "ðŸª£ Emptying S3 bucket..."
          aws s3 rm s3://$S3_BUCKET --recursive || true
        fi
        
        # Destroy infrastructure
        terraform destroy -auto-approve || true
        echo "âœ… Cleanup completed!"