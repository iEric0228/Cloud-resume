name: 'â˜ï¸ Cloud Resume CI/CD'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - deploy-test-keep
          - deploy-test-destroy
          - destroy-only
        default: deploy-test-destroy
      
      keep_alive_minutes:
        description: 'Minutes to keep running (for demos)'
        type: string
        default: '1'

  pull_request:
    branches: [ main ]
    paths:
      - 'website/**'
      - 'infra/**'

  push:
    branches: [ main ]
    paths:
      - 'website/**'
      - 'infra/**'

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'

jobs:
  # Validation job (runs on PRs)
  validate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: âš¡ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ðŸ” Validate Everything
      run: |
        # Terraform validation
        cd infra/environments/dev
        terraform init
        terraform validate
        terraform fmt -check
        echo "âœ… Terraform validation passed"
        
        # Website validation
        cd ../../../
        required_files=("website/index.html" "website/css/styles.css" "website/js/visitor-counter.js")
        for file in "${required_files[@]}"; do
          [[ -f "$file" ]] && echo "âœ… $file" || { echo "âŒ Missing $file"; exit 1; }
        done
        echo "âœ… Website files validation passed"

  # Main deploy job (runs on push, manual dispatch)
  deploy-resume:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: ðŸš€ Checkout Code
      uses: actions/checkout@v4

    - name: âš¡ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: ðŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::125156866057:role/github-OICD
        role-session-name: cloud-resume-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ðŸ—ï¸ Deploy Infrastructure
      if: github.event.inputs.action != 'destroy-only'
      working-directory: ./infra/environments/dev
      run: |
        echo "ðŸš€ Deploying cloud resume infrastructure..."
        terraform init
        terraform apply -auto-approve
        
        echo "ðŸ” Debug: Available Terraform outputs:"
        terraform output || echo "âŒ No outputs available"
        
        # Export outputs with better error handling
        S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        WEBSITE_URL=$(terraform output -raw website_url 2>/dev/null || echo "")  
        API_URL=$(terraform output -raw api_url 2>/dev/null || echo "")
        
        echo "ðŸ” Debug: Extracted values:"
        echo "S3_BUCKET='$S3_BUCKET'"
        echo "WEBSITE_URL='$WEBSITE_URL'"
        echo "API_URL='$API_URL'"
        
        # Validate required outputs
        if [ -z "$S3_BUCKET" ]; then
          echo "âŒ ERROR: S3 bucket name is empty!"
          echo "ðŸ” All available outputs:"
          terraform output -json || echo "No JSON outputs available"
          exit 1
        fi
        
        if [ -z "$WEBSITE_URL" ]; then
          echo "âŒ ERROR: Website URL is empty!"
          exit 1
        fi
        
        if [ -z "$API_URL" ]; then
          echo "âŒ ERROR: API URL is empty!"
          exit 1
        fi
        
        # Export to environment
        echo "S3_BUCKET=$S3_BUCKET" >> $GITHUB_ENV
        echo "WEBSITE_URL=$WEBSITE_URL" >> $GITHUB_ENV
        echo "API_URL=$API_URL" >> $GITHUB_ENV
        
        echo "âœ… All required outputs extracted successfully"

        - name: ðŸ“¤ Deploy Website
        if: github.event.inputs.action != 'destroy-only'
        run: |
          echo "ðŸ“¤ Deploying website files..."
          echo "ðŸ” Using S3 bucket: $S3_BUCKET"
          echo "ðŸ” Using API URL: $API_URL"
          
          # âœ… Replace placeholder API URL with real API Gateway URL
          echo "ðŸ”„ Updating visitor counter with API URL..."
          sed -i "s|REPLACE_WITH_API_URL|$API_URL|g" ./website/js/visitor-counter.js
          
          # Verify the replacement worked
          if grep -q "REPLACE_WITH_API_URL" ./website/js/visitor-counter.js; then
            echo "âš ï¸ WARNING: API URL replacement may have failed"
            grep -n "REPLACE_WITH_API_URL" ./website/js/visitor-counter.js
          else
            echo "âœ… API URL replacement successful"
          fi
          
          # Verify required files exist
          required_files=("./website/index.html" "./website/css/styles.css" "./website/js/visitor-counter.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ERROR: Required file $file not found!"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done
          
          # Deploy to S3 with proper content types
          aws s3 sync ./website/ s3://$S3_BUCKET/ --delete
          aws s3 cp ./website/index.html s3://$S3_BUCKET/index.html --content-type "text/html" --cache-control "no-cache"
          aws s3 cp ./website/css/styles.css s3://$S3_BUCKET/css/styles.css --content-type "text/css"
          aws s3 cp ./website/js/visitor-counter.js s3://$S3_BUCKET/js/visitor-counter.js --content-type "application/javascript"
          aws s3 cp ./website/js/animation.js s3://$S3_BUCKET/js/animation.js --content-type "application/javascript"
          
          echo "âœ… Website deployment completed"

    - name: ðŸ§ª Test Deployment
      if: github.event.inputs.action != 'destroy-only'
      run: |
        echo "ðŸ§ª Testing deployed resume..."
        sleep 60  # Wait for CloudFront
        
        # Test website
        curl -f $WEBSITE_URL && echo "âœ… Website working" || echo "âŒ Website failed"
        
        # Test API
        response=$(curl -s $API_URL/count)
        echo "API Response: $response"
        if echo "$response" | grep -q "visitor_count"; then
          echo "âœ… Visitor counter API working"
        else
          echo "âŒ API test failed"
        fi

    - name: ðŸ“Š Summary
      if: github.event.inputs.action != 'destroy-only'
      run: |
        echo "## â˜ï¸ Cloud Resume Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸŒ Live Website:** [$WEBSITE_URL]($WEBSITE_URL)" >> $GITHUB_STEP_SUMMARY
        echo "**âš¡ Visitor Counter API:** $API_URL/count" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        keep_hours="${{ github.event.inputs.keep_alive_hours || '24' }}"
        if [ "${{ github.event.inputs.action }}" = "deploy-test-destroy" ]; then
          echo "â° **Auto-cleanup scheduled in $keep_hours hour(s)**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Status:** Deployed and running" >> $GITHUB_STEP_SUMMARY
        fi

    - name: â³ Keep Running (Demo Period)
      if: github.event.inputs.action == 'deploy-test-keep' || github.event.inputs.action == 'deploy-test-destroy'
      run: |
        hours="${{ github.event.inputs.keep_alive_hours || '1' }}"
        echo "â³ Keeping resume live for $hours hour(s) for demo/testing..."
        echo "ðŸŒ Visit: $WEBSITE_URL"
        sleep $(($hours * 3600))

    - name: ðŸ—‘ï¸ Cleanup
      if: always() && (github.event.inputs.action == 'deploy-test-destroy' || github.event.inputs.action == 'destroy-only')
      working-directory: ./infra/environments/dev
      run: |
        echo "ðŸ—‘ï¸ Cleaning up resources..."
        
        # Get bucket name if we need to
        if [ "${{ github.event.inputs.action }}" = "destroy-only" ]; then
          S3_BUCKET=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "")
        fi
        
        # Empty S3 bucket
        if [ ! -z "$S3_BUCKET" ]; then
          echo "ðŸª£ Emptying S3 bucket..."
          aws s3 rm s3://$S3_BUCKET --recursive || true
        fi
        
        # Destroy infrastructure
        terraform destroy -auto-approve || true
        echo "âœ… Cleanup completed!"